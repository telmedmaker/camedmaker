{% extends "dashboard/base.html" %}
{% load mathfilters %}

{% block content %}
<div class="grid grid-cols-8 gap-8">
  <div class="flex flex-col gap-8 col-span-full lg:col-span-2">
    <!-- Patientenkarte -->
    <div class="flex items-start gap-3 border border-gray-200 rounded-md shadow-sm p-5 w-full bg-white">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mt-0.5 size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
      </svg>
      <div>
        <h2 class="text-lg">{{ med_request.user.full_name }}</h2>
        <hr class="my-3" />

        <div class="flex flex-col gap-3 text-gray-500 text-sm">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8.25v-1.5m0 1.5c-1.355 0-2.697.056-4.024.166C6.845 8.51 6 9.473 6 10.608v2.513m6-4.871c1.355 0 2.697.056 4.024.166C17.155 8.51 18 9.473 18 10.608v2.513M15 8.25v-1.5m-6 1.5v-1.5m12 9.75-1.5.75a3.354 3.354 0 0 1-3 0 3.354 3.354 0 0 0-3 0 3.354 3.354 0 0 1-3 0 3.354 3.354 0 0 0-3 0 3.354 3.354 0 0 1-3 0L3 16.5m15-3.379a48.474 48.474 0 0 0-6-.371c-2.032 0-4.034.126-6 .371m12 0c.39.049.777.102 1.163.16 1.07.16 1.837 1.094 1.837 2.175v5.169c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 0 1 3 20.625v-5.17c0-1.08.768-2.014 1.837-2.174A47.78 47.78 0 0 1 6 13.12M12.265 3.11a.375.375 0 1 1-.53 0L12 2.845l.265.265Zm-3 0a.375.375 0 1 1-.53 0L9 2.845l.265.265Zm6 0a.375.375 0 1 1-.53 0L15 2.845l.265.265Z" />
            </svg>
            <span>{{ med_request.user.age }} Jahre alt, {{ med_request.user.birth_date }}</span>
          </div>
  
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
            </svg>
            <span>{{ med_request.user.username }}</span>
          </div>

          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
            </svg>
            <span>{{ med_request.user.phone }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Vorherige Verschreibungen -->
    <div class="flex items-start gap-3 border border-gray-200 rounded-md shadow-sm p-5 w-full bg-white">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mt-0.5 size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
      </svg>
      <div>
        <h2 class="text-lg">Vorherige Anfragen</h2>
        <hr class="my-3" />

        <div class="flex flex-col gap-3 text-gray-500 text-sm">
          <div class="flex items-center gap-2">
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-span-full lg:col-span-3">
    <div class="border border-gray-200 rounded-md shadow-sm p-5 w-full bg-white">
      <div class="max-w-[600px]">
        <div class="flex items-center gap-3">
          <h2 class="text-lg">Medikamentenanfrage</h2>
          <span class="text-md text-gray-500 mt-0.5">{{ med_request.created }}</span>
        </div>

        <hr class="my-3" />

        <div class="flex flex-col gap-6">

          <div>
            <h2 class="text-sm font-bold">Symptome</h2>
            <div class="flex gap-4 h-full mt-4">
              <div class="w-2 rounded-lg bg-blue-500 bg-opacity-40"></div>
  
              <div class="py-2">
                <h3 class="mt-1 text-xs font-bold uppercase text-gray-500">Ausgewählt:</h3>
                <ul class="mt-1 ml-5 list-disc">
                  {% for symptom in med_request.symptoms %}
                  <li>
                    {{ symptom }}
                  </li>
                  {% endfor %}
                </ul>
                
                <h4 class="mt-5 text-xs font-bold uppercase text-gray-500">Beschreibung des Patienten:</h4>
                <p class="bg-gray-100 p-3 rounded-md mt-1 italic">{{ med_request.symptom_text }}</p>

                <h4 class="mt-5 text-xs font-bold uppercase text-gray-500">Wie schlimm sind die Symptome?</h4>
                <div class="flex items-center gap-1 mt-1">
                  {% with ''|center:med_request.symptom_severity as range %}
                  {% for _ in range %}
                    <div class="w-8 h-3 rounded-lg {% if med_request.symptom_severity < 7 %}bg-orange-300{% else %}bg-red-300{% endif %}"></div>
                  {% endfor %}
                  {% endwith %}

                  {% with left=10|sub:med_request.symptom_severity %}
                    {% with ''|center:left as range %}
                    {% for _ in range %}
                      <div class="w-8 h-3 rounded-lg bg-gray-100"></div>
                    {% endfor %}
                    {% endwith %}
                  {% endwith %}

                  <p class="text-sm ml-2">{{ med_request.symptom_severity }} von 10</p>
                  
                </div>
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-sm font-bold">Historie</h2>
            <div class="flex gap-4 h-full mt-4">
              <div class="w-2 rounded-lg bg-blue-500 bg-opacity-40"></div>
  
              <div class="py-2 text-sm">
                <h3 class="mt-1 text-xs font-bold uppercase text-gray-500">Wurde bereits behandelt?</h3>
                <div class="mt-1">
                  {% include 'dashboard/_boolean_text.html' with variable=med_request.was_already_treated %}
                </div>

                <h4 class="mt-5 text-xs font-bold uppercase text-gray-500">Werden Medikamente eingenommen?</h4>
                <p class="mt-1">
                  {% include 'dashboard/_boolean_text.html' with variable=med_request.previously_taken_medication %}
                </p>

                {% if med_request.previously_taken_medication %}
                <h4 class="mt-5 text-xs font-bold uppercase text-gray-500">Welche Medikamente</h4>
                <p class="mt-1">
                  {{ med_request.previous_medication_details }}
                </p>
                {% endif %}
                
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-sm font-bold">Cannabis</h2>
            <div class="flex gap-4 h-full mt-4">
              <div class="w-2 rounded-lg bg-blue-500 bg-opacity-40"></div>
  
              <div class="py-2 text-sm">
                <h3 class="mt-1 text-xs font-bold uppercase text-gray-500">Bereits Erfahrung?</h3>
                <div class="mt-1">
                  {% include 'dashboard/_boolean_text.html' with variable=med_request.previously_taken_cannabis %}
                </div>
                
                {% if med_request.previous_cannabis_details %}
                <h4 class="mt-5 text-xs font-bold uppercase text-gray-500">Warum Cannabis?</h4>
                <p class="mt-1">
                  {{ med_request.previous_cannabis_details }}
                </p>
                {% endif %}


              </div>
            </div>
          </div>

          

        </div>
        
      </div>
    </div>
  </div>

  <div class="col-span-full lg:col-span-3">
    <div class="border border-gray-200 rounded-md shadow-sm p-5 w-full bg-white">
      <div class="flex items-center gap-3">
        <h2 class="text-lg">Antwort</h2>
      </div>

      <hr class="my-3" />

      <form method="POST">
        {% csrf_token %}

        <input type="hidden" name="doctor" value="{{ request.user.id }}">
        <input type="hidden" name="medication_request" value="{{ med_request.number }}">

        <div class="flex flex-col gap-6">
          <div>
            <label for="diagnosis" class="text-sm font-bold">Diagnose / Behandlungsplan oder Ablehnungsgrund <span class="text-red-500">*</span></label>
            <textarea rows="4" name="diagnosis" id="diagnosis" class="mt-1 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-500 sm:text-sm/6"></textarea>
          </div>
          <div>
            <label for="private_notes" class="text-sm font-bold">Private Notizen <span class="text-gray-500">(optional)</span></label>
            <textarea rows="4" name="private_notes" id="private_notes" class="mt-1 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-500 sm:text-sm/6"></textarea>
          </div>
          <hr />
          <div>
            <label for="medication" class="text-sm font-bold">Medikation <span class="text-gray-500">(falls Behandlung akzeptiert)</span></label>
            <p class="text-xs text-gray-500 mt-1">Standardmäßig ist hier der Wunsch des Patienten eingetragen</p>
            <textarea rows="4" name="medication" id="medication" class="mt-2 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-500 sm:text-sm/6">{% for medication in med_request.medication_wish %}{{ medication.name }}, {{ medication.quantity }}mg&#x000D;{% endfor %}</textarea>
          </div>
        </div>
  
        <div class="flex justify-end gap-2 mt-5">
          <button
            type="submit"
            name="was_approved"
            value="no"
            class="flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 focus-visible:outline-red-600 text-white rounded-lg px-3 py-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
            <span>Speichern & Ablehnen</span>
          </button>
          <button
            type="submit"
            name="was_approved"
            value="yes"
            class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 focus-visible:outline-blue-600 text-white rounded-lg px-3 py-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
            <span>Speichern & Akzeptieren</span>
          </button>
        </div>
  
        <div class="flex justify-end">
          <div class="flex items-center gap-2 mt-3">
            <a
              href="tel:{{ med_request.user.phone }}"
              class="flex items-center justify-center gap-2 text-gray-700 rounded-lg px-3 py-3 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
              </svg>
              <span>Patienten anrufen</span>
            </a>
            <a
              href="mailto:{{ med_request.user.email }}"
              class="flex items-center justify-center gap-2 text-gray-700 rounded-lg px-3 py-3 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
              <span>E-Mail senden</span>
            </a>
          </div>
        </div>
      </form>
      

      <hr class="my-3"/>

      <div class="flex justify-end">
        <button type="button" class="flex items-center justify-center gap-2 text-gray-700 rounded-lg px-3 py-3 text-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811V8.69ZM12.75 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061a1.125 1.125 0 0 1-1.683-.977V8.69Z" />
          </svg>
          <span>Überspringen</span>
        </button>
      </div>
      
    </div>
  </div>
</div>
{% endblock content %}